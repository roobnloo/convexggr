---
title: "Untitled"
author: "Robin Liu"
date: "2022-08-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(modelr)
library(patchwork)
source("generate_data.R")
source("cv_cggr.R")
source("cggr.R")
source("test_utils.R")
```

```{r generate}
set.seed(100)
d <- 5
p <- 10
num <- 400
s <- generate_data(num, d, p, ve = 0.3)
trials <- 20
lambda_g <- 0.08
alpha <- 0.5
```

```{r}
node <- 3
cv_result <- cv_cggr(s$responses[, node], s$responses[, -node],
                     s$covariates, lambda_g, alpha, nfold = 5)
```

```{r}
plot(cv_result$lambda_seq, cv_result$result, type = "l", xlab = "lambda")
abline(v = cv_result$lambda_opt, col = "red")
```

```{r}
tuned_lambda_b <- numeric(length = d)
for (i in seq_len(d)) {
  cv_result <- cv_cggr(s$responses[, i], s$responses[, -i], s$covariates,
                       lambda_g, alpha, nfold = 5, lambda_min_prop = 0.01)
  plot(cv_result$lambda_seq, cv_result$result, type = "l", xlab = "lambda")
  abline(v = cv_result$lambda_opt, col = "red")
  tuned_lambda_b[i] <- cv_result$lambda_opt
}
tuned_lambda_b
```


```{r}
result <- convex_ggr(s$responses, s$covariates, lambda_g, tuned_lambda_b, alpha)
for (b_mx in result$beta_mxs) {
  print(beta_viz(b_mx))
}
```

```{r}
compute_idx <- c(1, 1 + s$cov_nz_idx)
for (i in seq_along(s$b_mxs)) {
  cov_lbl <- paste0("component ", compute_idx[i] - 1)
  computed <- beta_viz(result$beta_mxs[[compute_idx[i]]],
                       paste("Computed", cov_lbl))
  actual <- beta_viz(s$b_mxs[[i]], paste("Actual", cov_lbl))
  print(computed + actual)
}
```


```{r}
print(gamma_viz(result$gamma_mx))
print(gamma_viz(s$gamma_mx))
```
